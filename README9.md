## 서비스의 규모가 확장될 때 분리에 따른 트랜잭션 처리

현재 서비스는 크게 계좌(결제), 콘서트, 유저로 이루어져있다.
세부적으로 콘서트 안에는 콘서트 정보, 공연자 정보, 예약 정보 등이 있다.

서비스 규모가 확장됨에 따라 서비스가 나누어진다면 유저, 결제, 콘서트, 예약 등으로 나누어 질 것이다.

기존 아키텍처에서는 파사드 패턴을 사용하여 여러 서비스를 조합해 하나의 트랜잭션으로 묶어 관리했다.<br>
이를 통해 에러 발생 시 전체 롤백이 이루어지도록 보장했으나, 서비스가 분리되고 분산 환경으로 운영되면 DB 또한 개별적으로 분리되므로 전체 롤백을 하기가 어렵게된다.<br>
따라서 이러한 상황에서는 보상 트랜잭션이 필요하게된다.

### 해결 방안 : 이벤트 기반 아키텍처, 보상 트랜잭션 도입
각 서비스는 필요한 데이터를 조회, 변경 등 이벤트를 발행하고, 이를 구독하는 방식으로 데이터를 공유 및 업데이트할 수 있다.

ex) 결제 기능에 많은 기능들이 몰려있다.

```java
public Result paymentConcert(Criteria criteria) {
    유저조회();
    콘서트조회();
    콘서트정보조회();
    콘서트시트조회();
    계좌조회();
    결제();
    좌석정보업데이트();
    예약정보저장();
    대기열삭제();
}
```
개선된 코드
```java
public Result paymentConcert(Criteria criteria) {
    유저조회event();
    콘서트조회event();
    계좌조회();
    결제();
    좌석정보업데이트event();
    예약정보저장event();
    대기열삭제event();
}
```

1. 조회 이벤트 발행
   - 유저조회Event, 콘서트조회Event 등 필요한 데이터를 조회할 때 이벤트를 발행하여 다른 서비스에서 데이터를 가져온다.
2. 로컬 처리
   - 계좌 조회, 결제 기능 등 현재 시스템에서 처리 가능한 기능은 바로 수행한다.
3. 변경 이벤트 발행
   - 처리 완료 후 변경이 필요한 각 서비스에 이벤트 발행한다.
4. 보상 트랜잭션 처리
   - 특정 이벤트가 실패하면 이전에 발생한 데이터 변경을 모두 원복하는 보상 트랜잭션 이벤트를 발행한다. 예를 들어, 좌석 정보 업데이트나 예약 정보 저장이 실패한 경우, 결제 취소, 좌석 정보 원복 등 필요한 보상 작업이 진행될수 있도록 한다.

